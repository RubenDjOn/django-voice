{% extends "djangovoice/base.html" %}

{% load url from future %}
{% load gravatar djangovoice_tags comments i18n %}
{% load vote_buttons_for from qhonuskan_votes %}

{% block title %}{% trans "Feedback" %}{% endblock %}

{% block actions %}
  {% if user.is_staff or user == feedback.user %}
    <li><a href="{% url 'djangovoice_edit' feedback.id %}">{% trans "Edit" %} &rarr;</a></li>
    <li><a href="{% url 'djangovoice_delete' feedback.id %}">{% trans "Delete" %} &rarr;</a></li>
  {% endif %}
{% endblock %}

{% block content %}
  <div class="votes pull-left">
    {% vote_buttons_for feedback "djangovoice/includes/vote_buttons.html" %}
  </div>

  <span class="feedback-type feedback-type-{{ feedback.type.slug }} pull-right">
    {{ feedback.type.title }}
  </span>
  <span class="feedback-status feedback-status-{{ feedback.status.slug }} pull-right">
    {{ feedback.status.title }}
  </span>

  <h3 class="feedback-title content-spaces">{{ feedback.title }}</h3>

  {% if feedback.duplicate %}
    <div id="feedback-duplicate">
      {% trans "Duplicate of" %} <a href="{{ feedback.duplicate.get_absolute_url }}">{{ feedback.duplicate.title }}</a>
    </div>
  {% endif %}

  <p class="meta">
    <span class="feedback-user">
      {% if feedback.user %}
        {% trans "Submitted by" %}
        <a href="{{ feedback.user.get_absolute_url }}" title="{% trans "View profile" %}">{% user_name feedback.user %}</a>
      {% else %}
        {% trans "Submitted anonymously" %}
      {% endif %}
    </span>
    <span class="feedback-date">
      {% trans "on" %} {{ feedback.created|date:"d M Y" }}
    </span>
  </p>

  {% if feedback.description %}
    <p class="content-spaces">{{ feedback.description|urlize|linebreaksbr }}</p>
  {% endif %}

  <div class="content-spaces feedback-comments">
    {% get_comment_count for feedback as comment_count %}
    {% get_comment_list for feedback as comment_list %}

    <h4>
      {% blocktrans %}
        Comments ({{ comment_count }})
      {% endblocktrans %}
    </h4>

    {% if comment_list %}
      {% for comment in comment_list %}
        <div class="message{% if comment.user.is_staff %} staff{% endif %}">
          <a name="{{ message.id }}"></a>
          <div class="content">
            <div class="avatar">
              {% gravatar comment.user.username 40 %}
            </div>
            {% if comment.user.is_staff %}
              <div class="staff">
                {% trans "Staff" %}
              </div>
            {% endif %}
            <div class="message-content">
              <div class="details">
                {% trans "From:" %}<strong>
                {% ifequal comment.user user %}
                  {% trans "you" %}
                {% else %}
                  <a href="{{ comment.user.get_absolute_url }}">{% user_name comment.user %}</a>
                {% endifequal %}
                </strong>
                {% trans "on" %} {{ comment.submit_date|date:"M d Y" }} {% trans "at" %} {{ comment.submit_date|date:"fA" }}
              </div>
              <p>{{ comment.comment|urlize|linebreaksbr }}</p>
            </div>
            <div class="clear"></div>
          </div>
        </div>
      {% endfor %}

    {% else %}
      <p>{% trans "No one has commented. Have your say." %}</p>
    {% endif %}

    {% if user.is_authenticated %}
      <h4>{% trans "Leave a comment" %}</h4>
      {% get_comment_form for feedback as form %}
      <form action="{% comment_form_target %}" method="POST">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ feedback.get_absolute_url }}" />
        {{ form.comment }}
        {{ form.honeypot }}
        {{ form.content_type }}
        {{ form.object_pk }}
        {{ form.timestamp }}
        {{ form.security_hash }}
        <input type="submit" value="{% trans "Post comment" %}" id="id_submit" class="btn btn-primary" />
      </form>
    {% endif %}
  </div>
{% endblock %}
